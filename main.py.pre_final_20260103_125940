# ===== main.py =====
# Bybit SHORT Scanner ‚Äî Main Entry Point
# =======================================

import os
import sys
import time
import json
import subprocess
from typing import Dict, List, Optional

from PySide6.QtCore import Qt, QTimer, QEvent, QObject
from PySide6.QtGui import QColor, QFont
from PySide6.QtWidgets import (
    QApplication, QMainWindow, QWidget, QVBoxLayout, QHBoxLayout,
    QPushButton, QLabel, QTableWidget, QTableWidgetItem,
    QHeaderView, QAbstractItemView, QSplitter, QMessageBox
)

# –ò–º–ø–æ—Ä—Ç—ã –º–æ–¥—É–ª–µ–π
from core.config import get_config, AppConfig
from core.types import CoinRow
from core.bybit_client import BybitClient, get_client
from core.bridge import write_bridge_snapshot
from core.ml_logger import get_ml_logger
from strategies import get_strategy
from workers import ScannerWorker, CandidatesUpdateWorker
from ui.styles import (
    MAIN_STYLE, TABLE_TOP200_STYLE, TABLE_CANDIDATES_STYLE,
    BTN_EXIT_STYLE, SCANNER_SIZE, ROW_HEIGHT
)
from ui.dialogs import CountdownDialog

# Chart window (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
try:
    from ui.chart_window import show_chart
    HAS_CHART = True
    print("[DEBUG] chart_window imported successfully")
except ImportError as e:
    HAS_CHART = False
    print(f"[DEBUG] chart_window not available: {e}")


# === V2 IMPORTS (added by patch) ===
try:
    from core.config_v2 import USE_NEW_UI
    from core.engine_v2 import update_scan_timers, get_scan_state
    from ui.table_headers_v2 import get_header_manager
    V2_AVAILABLE = True
    print("[TRACE-V2] V2 –º–æ–¥—É–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ")
except ImportError as e:
    V2_AVAILABLE = False
    USE_NEW_UI = False
    print(f"[TRACE-V2] V2 –º–æ–¥—É–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã: {e}")
# === END V2 IMPORTS ===

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
CONFIG = get_config()
PAGE_SIZE = CONFIG.page_size
AUTO_RECALC_MIN = CONFIG.auto_recalc_minutes


class EscFilter(QObject):
    """–§–∏–ª—å—Ç—Ä ESC –¥–ª—è –æ—Ç–º–µ–Ω—ã –∞–≤—Ç–æ-—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è."""
    def __init__(self, callback):
        super().__init__()
        self.callback = callback
    
    def eventFilter(self, obj, event):
        if event.type() == QEvent.KeyPress and event.key() == Qt.Key_Escape:
            self.callback()
            return True
        return False


class MainWindow(QMainWindow):
    """–ì–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ —Å–∫–∞–Ω–µ—Ä–∞."""
    
    def __init__(self):
        super().__init__()
        self.setWindowTitle("Bybit SHORT Scanner ‚Äî Modular v3.0")
        self.resize(*SCANNER_SIZE)
        self.setMinimumSize(1400, 800)
        
        # –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
        self.client = get_client()
        self.strategy = get_strategy()
        self.ml_logger = get_ml_logger()
        
        # –°–æ—Å—Ç–æ—è–Ω–∏–µ
        self.rows: Dict[str, CoinRow] = {}
        self.worker: Optional[ScannerWorker] = None
        self.cand_worker: Optional[CandidatesUpdateWorker] = None
        self.current_page = 0
        self.scan_in_progress = False
        self.cand_update_in_progress = False
        
        # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        self.sort_col = 6  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ –æ–±–æ—Ä–æ—Ç—É
        self.sort_desc = True
        
        # UI
        self._build_ui()
        self._apply_styles()
        
        # –¢–∞–π–º–µ—Ä—ã
        self.auto_timer = QTimer(self)
        self.auto_timer.setInterval(AUTO_RECALC_MIN * 60 * 1000)
        self.auto_timer.timeout.connect(self._start_countdown)
        self.auto_timer.start()
        
        self.countdown_timer: Optional[QTimer] = None
        self.countdown_dialog: Optional[CountdownDialog] = None
        self.countdown_sec = 0
        
        # ESC —Ñ–∏–ª—å—Ç—Ä
        self.esc_filter = EscFilter(self._cancel_countdown)
        QApplication.instance().installEventFilter(self.esc_filter)
        


        # Live window (—Å–æ–∑–¥–∞—ë—Ç—Å—è –ø–æ –∫–Ω–æ–ø–∫–µ, —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–∞—Ç–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã)
        self.live_window = None  # type: ignore

        # –¢–∞–π–º–µ—Ä—ã UI (120—Å –ø–æ–ª–Ω—ã–π –ø–µ—Ä–µ—Å—á—ë—Ç)
        self._full_countdown = 120
        self._cand_countdown = 5  # –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
        self._cand_update_delay = 5  # –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ (—Å–µ–∫)

        self.full_countdown_timer = QTimer(self)
        self.full_countdown_timer.setInterval(1000)
        self.full_countdown_timer.timeout.connect(self._tick_full_countdown)
        self.full_countdown_timer.start()

        self.cand_countdown_timer = QTimer(self)
        self.cand_countdown_timer.setInterval(1000)
        self.cand_countdown_timer.timeout.connect(self._tick_cand_countdown)
        self.cand_countdown_timer.start()

        # –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        self._load_state()
    
    def _build_ui(self):
        root = QWidget()
        self.setCentralWidget(root)
        main = QVBoxLayout(root)
        main.setContentsMargins(10, 10, 10, 10)
        main.setSpacing(8)
        
        # === Top bar ===
        topbar = QHBoxLayout()
        
        self.lbl_status = QLabel("–ì–æ—Ç–æ–≤–æ")
        self.lbl_status.setMinimumWidth(200)
        topbar.addWidget(self.lbl_status)
        
        self.lbl_progress = QLabel("UNIVERSE: 0/200")
        topbar.addWidget(self.lbl_progress)
        
        topbar.addStretch()
        
        self.btn_prev = QPushButton("‚óÄ –ü—Ä–µ–¥")
        self.btn_next = QPushButton("–°–ª–µ–¥ ‚ñ∂")
        self.btn_refresh = QPushButton("üîÑ –û–±–Ω–æ–≤–∏—Ç—å")
        
        self.btn_prev.clicked.connect(self._prev_page)
        self.btn_next.clicked.connect(self._next_page)
        self.btn_refresh.clicked.connect(self._start_scan)
        
        topbar.addWidget(self.btn_prev)
        topbar.addWidget(self.btn_next)
        topbar.addWidget(self.btn_refresh)
        
        self.btn_live = QPushButton("üìà Live")
        self.btn_live.clicked.connect(self._toggle_live)
        topbar.addWidget(self.btn_live)
        
        self.btn_exit = QPushButton("‚èª –í—ã—Ö–æ–¥")
        self.btn_exit.setStyleSheet(BTN_EXIT_STYLE)
        self.btn_exit.clicked.connect(self._exit_app)
        topbar.addWidget(self.btn_exit)
        
        main.addLayout(topbar)
        
        # === Splitter ===
        splitter = QSplitter(Qt.Vertical)
        
        # TOP200 —Ç–∞–±–ª–∏—Ü–∞
        top_widget = QWidget()
        top_layout = QVBoxLayout(top_widget)
        top_layout.setContentsMargins(0, 0, 0, 0)
        
        self.lbl_top200 = QLabel("üìä TOP 200 –ø–æ –æ–±–æ—Ä–æ—Ç—É")
        self.lbl_top200.setStyleSheet("color: #00d4ff; font-size: 14px; font-weight: bold;")
        top_layout.addWidget(self.lbl_top200)
        
        self.lbl_full_timer = QLabel("–î–æ –ø–µ—Ä–µ—Å—á—ë—Ç–∞: 120 —Å–µ–∫")
        self.lbl_full_timer.setStyleSheet("color:#cfcfcf; font-size:12px;")
        top_layout.addWidget(self.lbl_full_timer)
        
        self.tbl_main = QTableWidget()
        self.tbl_main.setColumnCount(10)
        self.tbl_main.setHorizontalHeaderLabels([
            "–†–∞–Ω–≥", "–ú–æ–Ω–µ—Ç–∞", "–ü–æ–∑–∏—Ü–∏—è%", "–î–æ —Ö–∞—è%", "24—á%",
            "–¶–µ–Ω–∞", "–û–±–æ—Ä–æ—Ç(–ú)", "–§–∞–Ω–¥–∏–Ω–≥", "–°—Ç–∞—Ç—É—Å", "–°–∫–æ—Ä"
        ])
        self.tbl_main.horizontalHeader().setSectionResizeMode(QHeaderView.Stretch)
        self.tbl_main.setSelectionBehavior(QAbstractItemView.SelectRows)
        self.tbl_main.setEditTriggers(QAbstractItemView.NoEditTriggers)
        self.tbl_main.verticalHeader().setDefaultSectionSize(ROW_HEIGHT)
        self.tbl_main.setStyleSheet(TABLE_TOP200_STYLE)
        
        # –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã
        self.tbl_main.cellDoubleClicked.connect(self._on_double_click)
        self.tbl_main.horizontalHeader().sectionClicked.connect(self._on_header_click)
        print("[DEBUG] tbl_main signals connected")
        
        top_layout.addWidget(self.tbl_main)
        
        splitter.addWidget(top_widget)
        
        # –ö–∞–Ω–¥–∏–¥–∞—Ç—ã —Ç–∞–±–ª–∏—Ü–∞
        cand_widget = QWidget()
        cand_layout = QVBoxLayout(cand_widget)
        cand_layout.setContentsMargins(0, 0, 0, 0)
        
        self.lbl_candidates = QLabel("üéØ –ö–∞–Ω–¥–∏–¥–∞—Ç—ã –Ω–∞ SHORT")
        self.lbl_candidates.setStyleSheet("color: #ffd700; font-size: 14px; font-weight: bold;")
        cand_layout.addWidget(self.lbl_candidates)
        
        self.lbl_cand_timer = QLabel("–î–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: 10 —Å–µ–∫")
        self.lbl_cand_timer.setStyleSheet("color:#cfcfcf; font-size:12px;")
        cand_layout.addWidget(self.lbl_cand_timer)
        
        self.tbl_cand = QTableWidget()
        self.tbl_cand.setColumnCount(15)
        self.tbl_cand.setHorizontalHeaderLabels([
            "–ú–æ–Ω–µ—Ç–∞", "–í—Ä–µ–º—è", "–°—Ç–∞—Ç—É—Å", "–°–∫–æ—Ä", "–¢–∏–ø", "–ü–æ–∑–∏—Ü–∏—è%", "–î–æ —Ö–∞—è%",
            "24—á%", "–í—Ö–æ–¥", "SL", "TP1", "R/R", "G0", "G1", "G2"
        ])
        self.tbl_cand.horizontalHeader().setSectionResizeMode(QHeaderView.Stretch)
        self.tbl_cand.setSelectionBehavior(QAbstractItemView.SelectRows)
        self.tbl_cand.setEditTriggers(QAbstractItemView.NoEditTriggers)
        self.tbl_cand.verticalHeader().setDefaultSectionSize(ROW_HEIGHT - 2)
        self.tbl_cand.setStyleSheet(TABLE_CANDIDATES_STYLE)
        
        # –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∏–≥–Ω–∞–ª –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞
        self.tbl_cand.cellDoubleClicked.connect(self._on_double_click_cand)
        print("[DEBUG] tbl_cand signals connected")
        
        cand_layout.addWidget(self.tbl_cand)
        
        splitter.addWidget(cand_widget)
        splitter.setSizes([400, 300])
        
        main.addWidget(splitter)
    
    def _apply_styles(self):
        self.setStyleSheet(MAIN_STYLE)
        f = QFont()
        f.setPointSize(11)
        self.tbl_main.setFont(f)
        self.tbl_cand.setFont(f)
    
    # === –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ ===
    
    def _start_scan(self):
        if self.scan_in_progress:
            return
        
        self.scan_in_progress = True
        self.lbl_status.setText("‚è≥ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...")
        try:
            self.lbl_full_timer.setStyleSheet("color:#ffd700; font-size:12px; font-weight:bold;")
            self.lbl_full_timer.setText("–ü–µ—Ä–µ—Å—á—ë—Ç: 0/‚Ä¶")
        except Exception:
            pass
        self.btn_refresh.setEnabled(False)
        
        self.worker = ScannerWorker(
            client=self.client,
            strategy=self.strategy,
            top_n=CONFIG.universe_size,
            max_workers=CONFIG.max_workers
        )
        self.worker.progress.connect(self._on_progress)
        self.worker.finished_all.connect(self._on_finished)
        self.worker.error.connect(self._on_error)
        self.worker.start()
    
    def _on_progress(self, current: int, total: int, symbol: str):
        self.lbl_progress.setText(f"UNIVERSE: {current}/{total} | {symbol}")
        try:
            self.lbl_full_timer.setStyleSheet("color:#ffd700; font-size:12px; font-weight:bold;")
            self.lbl_full_timer.setText(f"–ü–µ—Ä–µ—Å—á—ë—Ç: {current}/{total}")
        except Exception:
            pass
    
    def _on_finished(self, results: Dict[str, CoinRow]):
        self.rows = results
        self.scan_in_progress = False
        self.btn_refresh.setEnabled(True)
        self.lbl_status.setText(f"‚úÖ –ì–æ—Ç–æ–≤–æ ({len(results)} –º–æ–Ω–µ—Ç)")
        self._full_countdown = 120
        try:
            self.lbl_full_timer.setStyleSheet("color:#cfcfcf; font-size:12px;")
            self.lbl_full_timer.setText(f"–î–æ –ø–µ—Ä–µ—Å—á—ë—Ç–∞: {self._full_countdown} —Å–µ–∫")
        except Exception:
            pass
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—ã
        self._render_main_table()
        self._render_candidates()
        
        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º bridge –¥–ª—è Trainer
        write_bridge_snapshot(self.rows, top_n=30)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        self._save_state()
    
    def _on_error(self, msg: str):
        self.scan_in_progress = False
        self.btn_refresh.setEnabled(True)
        self.lbl_status.setText("‚ùå –û—à–∏–±–∫–∞")
        QMessageBox.warning(self, "–û—à–∏–±–∫–∞", msg)
    
    # === –¢–∞–±–ª–∏—Ü—ã ===
    
    def _render_main_table(self):
        # –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        def get_sort_key(r: CoinRow):
            if self.sort_col == 0:    # –†–∞–Ω–≥ (–ø–æ –æ–±–æ—Ä–æ—Ç—É)
                return r.vol24_m
            elif self.sort_col == 1:  # –ú–æ–Ω–µ—Ç–∞
                return r.symbol
            elif self.sort_col == 2:  # –ü–æ–∑–∏—Ü–∏—è%
                return r.range_position
            elif self.sort_col == 3:  # –î–æ —Ö–∞—è%
                return r.dist_high_pct
            elif self.sort_col == 4:  # 24—á%
                return r.change_24h_pct
            elif self.sort_col == 5:  # –¶–µ–Ω–∞
                return r.price_now
            elif self.sort_col == 6:  # –û–±–æ—Ä–æ—Ç
                return r.vol24_m
            elif self.sort_col == 7:  # –§–∞–Ω–¥–∏–Ω–≥
                return r.funding_rate
            elif self.sort_col == 8:  # –°—Ç–∞—Ç—É—Å
                status_order = {"–í–•–û–î": 4, "–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å": 3, "–ò–Ω—Ç–µ—Ä–µ—Å": 2, "–ù–∞–±–ª—é–¥–µ–Ω–∏–µ": 1, "": 0}
                return status_order.get(r.status, 0)
            elif self.sort_col == 9:  # –°–∫–æ—Ä
                return r.score
            return r.vol24_m
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º
        sorted_rows = sorted(
            self.rows.values(),
            key=get_sort_key,
            reverse=self.sort_desc
        )
        
        # –ü–∞–≥–∏–Ω–∞—Ü–∏—è
        start = self.current_page * PAGE_SIZE
        end = start + PAGE_SIZE
        page_rows = sorted_rows[start:end]
        
        self.tbl_main.setRowCount(len(page_rows))
        
        for i, row in enumerate(page_rows):
            rank = start + i + 1
            
            # –¶–≤–µ—Ç –ø–æ —Å—Ç–∞—Ç—É—Å—É
            if row.status == "–í–•–û–î":
                color = QColor(255, 80, 80)
            elif row.status == "–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å":
                color = QColor(255, 180, 0)
            elif row.status == "–ò–Ω—Ç–µ—Ä–µ—Å":
                color = QColor(100, 180, 255)
            else:
                color = QColor(200, 200, 200)
            
            values = [
                str(rank),
                row.symbol.replace("USDT", ""),
                f"{row.range_position:.1f}",
                f"{row.dist_high_pct:.2f}",
                f"{row.change_24h_pct:+.1f}",
                f"{row.price_now:.6f}",
                f"{row.vol24_m}",
                f"{row.funding_rate*100:.4f}",
                row.status,
                f"{row.score:.0f}"
            ]
            
            for col, val in enumerate(values):
                item = QTableWidgetItem(val)
                item.setTextAlignment(Qt.AlignCenter)
                if col >= 8:
                    item.setForeground(color)
                self.tbl_main.setItem(i, col, item)
        
        total_pages = (len(sorted_rows) + PAGE_SIZE - 1) // PAGE_SIZE
        self.lbl_top200.setText(f"üìä TOP 200 | –°—Ç—Ä–∞–Ω–∏—Ü–∞ {self.current_page + 1}/{total_pages}")
    
    def _render_candidates(self):
        """
        –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤:
        - –ö–æ–ª–æ–Ω–∫–∞ "–í—Ä–µ–º—è" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ –º–æ–Ω–µ—Ç—ã
        - –ú–æ–Ω–µ—Ç—ã "–ù–∞–±–ª—é–¥–µ–Ω–∏–µ" —Å—Ç–∞—Ä—à–µ 30 –º–∏–Ω—É—Ç —É–¥–∞–ª—è—é—Ç—Å—è
        - –ú–∞–∫—Å–∏–º—É–º 30 –º–æ–Ω–µ—Ç, —Å–ª–∞–±—ã–µ —É–¥–∞–ª—è—é—Ç—Å—è
        """
        import time as time_module
        now = time_module.time()
        
        # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –º–æ–Ω–µ—Ç —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–ù–∞–±–ª—é–¥–µ–Ω–∏–µ" (> 30 –º–∏–Ω—É—Ç)
        to_remove = []
        for sym, row in self.rows.items():
            if row.status == "–ù–∞–±–ª—é–¥–µ–Ω–∏–µ" and row.added_at > 0:
                age_min = (now - row.added_at) / 60
                if age_min > 30:
                    to_remove.append(sym)
        
        for sym in to_remove:
            del self.rows[sym]
            print(f"[DEBUG] –£–¥–∞–ª–µ–Ω–∞ –º–æ–Ω–µ—Ç–∞ {sym} (–ù–∞–±–ª—é–¥–µ–Ω–∏–µ > 30 –º–∏–Ω)")
        
        # –§–∏–ª—å—Ç—Ä—É–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ (—Å–æ —Å—Ç–∞—Ç—É—Å–æ–º)
        candidates = [
            r for r in self.rows.values()
            if r.status in ("–ò–Ω—Ç–µ—Ä–µ—Å", "–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å", "–í–•–û–î", "–ù–∞–±–ª—é–¥–µ–Ω–∏–µ")
            and r.score > 20
        ]
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º: —Å–Ω–∞—á–∞–ª–∞ –ø–æ —Å—Ç–∞—Ç—É—Å—É, –ø–æ—Ç–æ–º –ø–æ —Å–∫–æ—Ä—É
        status_priority = {"–í–•–û–î": 0, "–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å": 1, "–ò–Ω—Ç–µ—Ä–µ—Å": 2, "–ù–∞–±–ª—é–¥–µ–Ω–∏–µ": 3}
        candidates.sort(key=lambda r: (status_priority.get(r.status, 99), -r.score))
        
        # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 30 –º–æ–Ω–µ—Ç ‚Äî —É–¥–∞–ª—è–µ–º —Å–ª–∞–±—ã–µ
        if len(candidates) > 30:
            weak = candidates[30:]
            candidates = candidates[:30]
            for r in weak:
                if r.status == "–ù–∞–±–ª—é–¥–µ–Ω–∏–µ":
                    if r.symbol in self.rows:
                        del self.rows[r.symbol]
                        print(f"[DEBUG] –£–¥–∞–ª–µ–Ω–∞ —Å–ª–∞–±–∞—è –º–æ–Ω–µ—Ç–∞ {r.symbol}")
        
        self.tbl_cand.setRowCount(len(candidates))
        
        for i, row in enumerate(candidates):
            # –¶–≤–µ—Ç –ø–æ —Å—Ç–∞—Ç—É—Å—É
            if row.status == "–í–•–û–î":
                color = QColor(255, 80, 80)
            elif row.status == "–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å":
                color = QColor(255, 180, 0)
            elif row.status == "–ò–Ω—Ç–µ—Ä–µ—Å":
                color = QColor(100, 180, 255)
            else:
                color = QColor(150, 150, 150)
            
            # –í—Ä–µ–º—è –∂–∏–∑–Ω–∏
            if row.added_at > 0:
                age_sec = int(now - row.added_at)
                age_min = age_sec // 60
                age_sec_rem = age_sec % 60
                time_str = f"{age_min}–º{age_sec_rem:02d}—Å"
            else:
                time_str = "‚Äî"
            
            values = [
                row.symbol.replace("USDT", ""),
                time_str,
                row.status,
                f"{row.score:.0f}",
                row.watch_type,
                f"{row.range_position:.1f}",
                f"{row.dist_high_pct:.2f}",
                f"{row.change_24h_pct:+.1f}",
                f"{row.entry_price:.6f}",
                f"{row.sl_price:.6f}",
                f"{row.tp1:.6f}",
                f"{row.rr:.2f}",
                "‚úì" if row.gate0_passed else "‚úó",
                "‚úì" if row.gate1_passed else "‚úó",
                "‚úì" if row.gate2_passed else "‚úó"
            ]
            
            for col, val in enumerate(values):
                item = QTableWidgetItem(val)
                item.setTextAlignment(Qt.AlignCenter)
                if col <= 4:  # –ú–æ–Ω–µ—Ç–∞, –í—Ä–µ–º—è, –°—Ç–∞—Ç—É—Å, –°–∫–æ—Ä, –¢–∏–ø
                    item.setForeground(color)
                self.tbl_cand.setItem(i, col, item)
        
        self.lbl_candidates.setText(f"üéØ –ö–∞–Ω–¥–∏–¥–∞—Ç—ã –Ω–∞ SHORT ({len(candidates)})")
    
    def _add_to_candidates(self, row: CoinRow):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–æ–Ω–µ—Ç—ã –≤ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã —Å —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –≤—Ä–µ–º–µ–Ω–∏."""
        import time as time_module
        if row.added_at <= 0:
            row.added_at = time_module.time()
        self.rows[row.symbol] = row
    
    # === –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ ===
    
    def _on_double_click(self, row_idx: int, col_idx: int):
        """–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –Ω–∞ –º–æ–Ω–µ—Ç—É –≤ TOP200 ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –≥—Ä–∞—Ñ–∏–∫."""
        print(f"[DEBUG] Double click TOP200: row={row_idx}, col={col_idx}")
        
        if not HAS_CHART:
            print("[DEBUG] Chart not available")
            return
        
        try:
            item = self.tbl_main.item(row_idx, 1)  # –ö–æ–ª–æ–Ω–∫–∞ "–ú–æ–Ω–µ—Ç–∞"
            if not item:
                return
            
            symbol = item.text().strip()
            if not symbol:
                return
            if not symbol.endswith("USDT"):
                symbol += "USDT"
            
            print(f"[DEBUG] Opening chart for {symbol}")
            
            row = self.rows.get(symbol)
            if not row:
                print(f"[DEBUG] Row not found for {symbol}")
                return
            
            # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–≤–µ—á–∏
            klines = {}
            try:
                for tf in ["15", "60", "240"]:
                    klines[tf] = self.client.get_klines(symbol, tf, limit=100)
            except Exception as e:
                print(f"[DEBUG] Klines error: {e}")
            
            # BTC –¥–∞–Ω–Ω—ã–µ
            btc_row = self.rows.get("BTCUSDT")
            btc_price = btc_row.price_now if btc_row else 0
            btc_change = btc_row.change_24h_pct if btc_row else 0
            
            show_chart(row, btc_price, btc_change, klines)
            
        except Exception as e:
            print(f"[DEBUG] Double click error: {e}")
            import traceback
            traceback.print_exc()
    
    def _on_double_click_cand(self, row_idx: int, col_idx: int):
        """–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –Ω–∞ –º–æ–Ω–µ—Ç—É –≤ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞—Ö ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –≥—Ä–∞—Ñ–∏–∫."""
        print(f"[DEBUG] Double click Candidates: row={row_idx}, col={col_idx}")
        
        if not HAS_CHART:
            print("[DEBUG] Chart not available")
            return
        
        try:
            item = self.tbl_cand.item(row_idx, 0)  # –ö–æ–ª–æ–Ω–∫–∞ "–ú–æ–Ω–µ—Ç–∞"
            if not item:
                return
            
            symbol = item.text().strip()
            if not symbol:
                return
            if not symbol.endswith("USDT"):
                symbol += "USDT"
            
            print(f"[DEBUG] Opening chart for {symbol}")
            
            row = self.rows.get(symbol)
            if not row:
                print(f"[DEBUG] Row not found for {symbol}")
                return
            
            # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–≤–µ—á–∏
            klines = {}
            try:
                for tf in ["15", "60", "240"]:
                    klines[tf] = self.client.get_klines(symbol, tf, limit=100)
            except Exception as e:
                print(f"[DEBUG] Klines error: {e}")
            
            # BTC –¥–∞–Ω–Ω—ã–µ
            btc_row = self.rows.get("BTCUSDT")
            btc_price = btc_row.price_now if btc_row else 0
            btc_change = btc_row.change_24h_pct if btc_row else 0
            
            show_chart(row, btc_price, btc_change, klines)
            
        except Exception as e:
            print(f"[DEBUG] Double click error: {e}")
            import traceback
            traceback.print_exc()
    
    def _on_header_click(self, col: int):
        """–ö–ª–∏–∫ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É ‚Äî —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞."""
        print(f"[DEBUG] Header clicked: col={col}")
        
        if self.sort_col == col:
            self.sort_desc = not self.sort_desc
        else:
            self.sort_col = col
            self.sort_desc = True
        
        self._render_main_table()
    
    # === –ü–∞–≥–∏–Ω–∞—Ü–∏—è ===
    
    def _prev_page(self):
        if self.current_page > 0:
            self.current_page -= 1
            self._render_main_table()
    
    def _next_page(self):
        total = len(self.rows)
        max_page = (total + PAGE_SIZE - 1) // PAGE_SIZE - 1
        if self.current_page < max_page:
            self.current_page += 1
            self._render_main_table()
    
    # === Countdown ===
    
    def _start_countdown(self):
        if self.scan_in_progress:
            return
        
        self.countdown_sec = 10
        self.countdown_dialog = CountdownDialog(self)
        self.countdown_dialog.set_seconds(self.countdown_sec)
        self.countdown_dialog.rejected.connect(self._cancel_countdown)
        self.countdown_dialog.show()
        
        self.countdown_timer = QTimer(self)
        self.countdown_timer.setInterval(1000)
        self.countdown_timer.timeout.connect(self._countdown_tick)
        self.countdown_timer.start()
    
    def _countdown_tick(self):
        self.countdown_sec -= 1
        
        if self.countdown_sec <= 0:
            self._stop_countdown()
            self._start_scan()
        elif self.countdown_dialog:
            self.countdown_dialog.set_seconds(self.countdown_sec)
    
    def _cancel_countdown(self):
        self._stop_countdown()
        self.lbl_status.setText("–ê–≤—Ç–æ-–ø–µ—Ä–µ—Å—á—ë—Ç –æ—Ç–º–µ–Ω—ë–Ω")
    
    def _stop_countdown(self):
        if self.countdown_timer:
            self.countdown_timer.stop()
            self.countdown_timer = None
        if self.countdown_dialog:
            self.countdown_dialog.close()
            self.countdown_dialog = None
    
    # === State ===
    
    def _save_state(self):
        try:
            state = {
                "current_page": self.current_page,
                "last_scan": time.time()
            }
            path = os.path.join(CONFIG.base_dir, "scanner_state.json")
            with open(path, "w") as f:
                json.dump(state, f)
        except:
            pass
    
    def _load_state(self):
        try:
            path = os.path.join(CONFIG.base_dir, "scanner_state.json")
            if os.path.exists(path):
                with open(path) as f:
                    state = json.load(f)
                self.current_page = state.get("current_page", 0)
        except:
            pass
    

    # === –¢–∞–π–º–µ—Ä—ã UI ===
    def _tick_full_countdown(self):
        # –ù–µ —Ç—Ä–∞—Ç–∏–º —Ä–µ—Å—É—Ä—Å—ã –≤–æ –≤—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        # === V2 CALL ===
        print("[TRACE-V2] _tick_full_countdown –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è")
        if V2_AVAILABLE and USE_NEW_UI:
            try:
                self._update_v2_progress()
            except Exception as e:
                print(f"[TRACE-V2] –û—à–∏–±–∫–∞ –≤—ã–∑–æ–≤–∞: {e}")
        # === END V2 CALL ===

        if self.scan_in_progress:
            return
        self._full_countdown -= 1
        if self._full_countdown <= 0:
            self._full_countdown = 120
            self._start_scan()
            return
        try:
            self.lbl_full_timer.setStyleSheet("color:#cfcfcf; font-size:12px;")
            self.lbl_full_timer.setText(f"–î–æ –ø–µ—Ä–µ—Å—á—ë—Ç–∞: {self._full_countdown} —Å–µ–∫")
        except Exception:
            pass

    def _tick_cand_countdown(self):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ ‚Äî –∂–¥—ë–º 5 —Å–µ–∫ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è, –ø–æ—Ç–æ–º —Å–Ω–æ–≤–∞ –∑–∞–ø—Ä–æ—Å."""
        if self.scan_in_progress or self.cand_update_in_progress:
            return
        
        self._cand_countdown -= 1
        
        if self._cand_countdown <= 0:
            # –ù–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –∑–¥–µ—Å—å ‚Äî –æ–Ω —Å–±—Ä–æ—Å–∏—Ç—Å—è –≤ _on_cand_finished
            self._start_cand_update()
            return
        
        try:
            self.lbl_cand_timer.setStyleSheet("color:#cfcfcf; font-size:12px;")
            self.lbl_cand_timer.setText(f"–î–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: {self._cand_countdown} —Å–µ–∫")
        except Exception:
            pass

    def _start_cand_update(self):
        """–ó–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤."""
        if not self.rows or self.cand_update_in_progress:
            return
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤–æ—Ä–∫–µ—Ä –∑–∞–≤–µ—Ä—à–∏–ª—Å—è
        if self.cand_worker is not None:
            if self.cand_worker.isRunning():
                print("[DEBUG] –ü—Ä–µ–¥—ã–¥—É—â–∏–π cand_worker –µ—â—ë —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º")
                return
            # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π –≤–æ—Ä–∫–µ—Ä
            try:
                self.cand_worker.deleteLater()
            except Exception:
                pass
            self.cand_worker = None
        
        self.cand_update_in_progress = True
        
        try:
            self.lbl_cand_timer.setStyleSheet("color:#ffd700; font-size:12px; font-weight:bold;")
            self.lbl_cand_timer.setText("üîÑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...")
        except Exception:
            pass
        
        # –°–æ–∑–¥–∞—ë–º –≤–æ—Ä–∫–µ—Ä
        self.cand_worker = CandidatesUpdateWorker(
            client=self.client,
            strategy=self.strategy,
            rows=self.rows,
            max_candidates=25,  # –°–∫–∞–Ω–∏—Ä—É–µ–º 25 –º–æ–Ω–µ—Ç –∑–∞ 30 —Å–µ–∫
        )
        self.cand_worker.progress.connect(self._on_cand_progress)
        self.cand_worker.coin_updated.connect(self._on_coin_updated)  # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        self.cand_worker.finished.connect(self._on_cand_finished)
        self.cand_worker.error.connect(self._on_cand_error)
        self.cand_worker.start()
    
    def _on_cand_progress(self, current: int, total: int, symbol: str):
        """–ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤."""
        try:
            self.lbl_cand_timer.setText(f"üîÑ {current}/{total} | {symbol}")
        except Exception:
            pass
    
    def _on_coin_updated(self, symbol: str, row: CoinRow):
        """–ú–æ–Ω–µ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ (UI –æ–±–Ω–æ–≤–∏—Ç—Å—è –≤ –∫–æ–Ω—Ü–µ)."""
        # –¢–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ, UI –æ–±–Ω–æ–≤–∏—Ç—Å—è –≤ _on_cand_finished
        self.rows[symbol] = row
    
    def _on_cand_finished(self, updated_rows: Dict[str, CoinRow]):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–æ ‚Äî –∂–¥—ë–º 5 —Å–µ–∫ –∏ —Å–Ω–æ–≤–∞ –æ–±–Ω–æ–≤–ª—è–µ–º."""
        self.cand_update_in_progress = False
        
        if updated_rows:
            self.rows = updated_rows
        
        # –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã
        self._render_candidates()
        self._render_main_table()
        
        # –û–±–Ω–æ–≤–ª—è–µ–º bridge –¥–ª—è Live
        write_bridge_snapshot(self.rows, top_n=30)
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –Ω–∞ 5 —Å–µ–∫—É–Ω–¥ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        self._cand_countdown = 5
        
        try:
            self.lbl_cand_timer.setStyleSheet("color:#22c55e; font-size:12px;")
            self.lbl_cand_timer.setText(f"‚úì –û–±–Ω–æ–≤–ª–µ–Ω–æ | –°–ª–µ–¥: {self._cand_countdown} —Å–µ–∫")
        except Exception:
            pass
        
        print(f"[DEBUG] Candidates update finished: {len(updated_rows)} rows")
    
    def _on_cand_error(self, msg: str):
        """–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤."""
        self.cand_update_in_progress = False
        print(f"[DEBUG] Candidates update error: {msg}")
        
        try:
            self.lbl_cand_timer.setStyleSheet("color:#ef4444; font-size:12px;")
            self.lbl_cand_timer.setText(f"‚ùå –û—à–∏–±–∫–∞ | –°–ª–µ–¥: {self._cand_countdown} —Å–µ–∫")
        except Exception:
            pass

    def _toggle_live(self):
        # –õ–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–∫–Ω–∞ Live
        if self.live_window is None:
            try:
                from trainer_live import TrainerLive  # type: ignore
                self.live_window = TrainerLive()
            except Exception as e:
                QMessageBox.critical(self, "Live", f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å Live: {e}")
                self.live_window = None
                return

        if self.live_window.isVisible():
            try:
                if hasattr(self.live_window, "set_active"):
                    self.live_window.set_active(False)
            except Exception:
                pass
            self.live_window.hide()
        else:
            self.live_window.show()
            try:
                self.live_window.raise_()
                self.live_window.activateWindow()
            except Exception:
                pass
            try:
                if hasattr(self.live_window, "set_active"):
                    self.live_window.set_active(True)
            except Exception:
                pass


    def _exit_app(self):
        """–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è."""
        print("[DEBUG] –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...")
        
        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ —Ç–∞–π–º–µ—Ä—ã
        try:
            self.auto_timer.stop()
            self.full_countdown_timer.stop()
            self.cand_countdown_timer.stop()
            if self.countdown_timer:
                self.countdown_timer.stop()
        except Exception:
            pass
        
        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –≤–æ—Ä–∫–µ—Ä —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        if self.worker and self.worker.isRunning():
            print("[DEBUG] –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º scanner worker...")
            self.worker.stop()
            self.worker.wait(2000)
        
        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–æ—Ä–∫–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
        if self.cand_worker and self.cand_worker.isRunning():
            print("[DEBUG] –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º candidates worker...")
            self.cand_worker.stop()
            self.cand_worker.wait(2000)
        
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º Live –æ–∫–Ω–æ
        if self.live_window:
            try:
                self.live_window.close()
            except Exception:
                pass
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        self._save_state()
        
        print("[DEBUG] –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ")
        QApplication.quit()
    

    def _update_v2_progress(self):
        """[V2] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–≤."""
        print("[TRACE-V2] _update_v2_progress –≤—ã–∑–≤–∞–Ω")
        try:
            if not V2_AVAILABLE:
                print("[TRACE-V2] V2_AVAILABLE = False, –≤—ã—Ö–æ–¥")
                return
            if not USE_NEW_UI:
                print("[TRACE-V2] USE_NEW_UI = False, –≤—ã—Ö–æ–¥")
                return
            
            print("[TRACE-V2] –û–±–Ω–æ–≤–ª—è—é —Ç–∞–π–º–µ—Ä—ã...")
            update_scan_timers()
            scan_state = get_scan_state()
            
            header_mgr = get_header_manager()
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä—ã
            header_mgr.update_timers(
                level1_left=scan_state.get('level1_countdown', 0),
                level2_left=scan_state.get('level2_countdown', 0),
                level3_left=scan_state.get('level3_countdown', 0)
            )
            
            # –î–∞–Ω–Ω—ã–µ TOP200
            top200_data = getattr(self, 'all_results', {})
            if top200_data:
                rows = list(top200_data.values())
                class_count = sum(1 for r in rows if getattr(r, 'watch_type', None))
                pump5m_count = sum(1 for r in rows if '–ü–∞–º–ø' in str(getattr(r, 'watch_type', '') or ''))
                extr1m_count = sum(1 for r in rows if getattr(r, 'range_position', 0) > 90)
                combo_count = sum(1 for r in rows if getattr(r, 'watch_type', None) and getattr(r, 'range_position', 0) > 85)
                header_mgr.update_criteria_counts(class_count, pump5m_count, extr1m_count, combo_count)
            
            # –î–∞–Ω–Ω—ã–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
            candidates_data = getattr(self, 'candidates', [])
            if candidates_data:
                watch = sum(1 for c in candidates_data if getattr(c, 'status', '') == '–ù–∞–±–ª—é–¥–µ–Ω–∏–µ')
                interest = sum(1 for c in candidates_data if getattr(c, 'status', '') == '–ò–Ω—Ç–µ—Ä–µ—Å')
                ready = sum(1 for c in candidates_data if getattr(c, 'status', '') == '–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å')
                entry = sum(1 for c in candidates_data if getattr(c, 'status', '') == '–í–•–û–î')
                header_mgr.update_status_counts(watch, interest, ready, entry)
            
            # –û–±–Ω–æ–≤–ª—è–µ–º UI
            top200_text = header_mgr.get_top200_header_text()
            cand_text = header_mgr.get_candidates_header_text()
            
            print(f"[TRACE-V2] top200_text: {top200_text[:50] if top200_text else 'None'}...")
            print(f"[TRACE-V2] cand_text: {cand_text[:50] if cand_text else 'None'}...")
            
            if hasattr(self, 'lbl_full_timer') and top200_text:
                self.lbl_full_timer.setText(top200_text)
                self.lbl_full_timer.setWordWrap(True)
                self.lbl_full_timer.setMinimumHeight(45)
                print("[TRACE-V2] lbl_full_timer –æ–±–Ω–æ–≤–ª—ë–Ω")
            
            if hasattr(self, 'lbl_cand_timer') and cand_text:
                self.lbl_cand_timer.setText(cand_text)
                self.lbl_cand_timer.setWordWrap(True)
                self.lbl_cand_timer.setMinimumHeight(45)
                print("[TRACE-V2] lbl_cand_timer –æ–±–Ω–æ–≤–ª—ë–Ω")
                
        except Exception as e:
            print(f"[TRACE-V2] –û—à–∏–±–∫–∞: {e}")


    def closeEvent(self, event):
        self._exit_app()
        event.accept()


def main():
    # –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    os.makedirs(CONFIG.base_dir, exist_ok=True)
    os.makedirs(CONFIG.logs_dir, exist_ok=True)
    os.makedirs(CONFIG.ml_data_dir, exist_ok=True)
    
    app = QApplication(sys.argv)
    app.setStyle('Fusion')
    
    window = MainWindow()
    window.show()
    
    # –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    QTimer.singleShot(1000, window._start_scan)
    
    sys.exit(app.exec())


if __name__ == "__main__":
    main()
